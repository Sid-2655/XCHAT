<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>XChat</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      font-family: Arial;
      padding: 20px;
      max-width: 500px;
      margin: auto;
    }

    button, input {
      width: 100%;
      padding: 12px;
      margin: 8px 0;
      font-size: 16px;
    }

    #chat {
      border: 1px solid #ccc;
      height: 200px;
      overflow-y: auto;
      padding: 10px;
      margin-top: 10px;
    }
  </style>
</head>
<body>

<h2>XChat</h2>

<button onclick="showHost()">Host</button>
<button onclick="showJoin()">Join</button>

<div id="controls"></div>

<div id="chat"></div>
<input id="messageInput" placeholder="Type message..." />
<button onclick="sendMessage()">Send</button>

<script>
let pc;
let dc;
let sessionId;
let pollInterval;

function createPeer() {
  pc = new RTCPeerConnection({
    iceServers: [
      { urls: "stun:stun.l.google.com:19302" }
    ]
  });

  pc.onicecandidate = async (event) => {
    if (event.candidate) {
      await fetch(`/api/session?id=${sessionId}`, {
        method: "PATCH",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ candidate: event.candidate })
      });
    }
  };

  pc.onconnectionstatechange = () => {
    if (pc.connectionState === "connected") {
      alert("Peer Connected!");
      clearInterval(pollInterval);
    }
  };

  pc.ondatachannel = (event) => {
    dc = event.channel;
    setupDataChannel();
  };
}

function setupDataChannel() {
  dc.onmessage = (event) => {
    addMessage("Peer: " + event.data);
  };
}

function addMessage(msg) {
  const chat = document.getElementById("chat");
  chat.innerHTML += "<div>" + msg + "</div>";
  chat.scrollTop = chat.scrollHeight;
}

function showHost() {
  document.getElementById("controls").innerHTML = `
    <input id="hostCode" placeholder="Enter your session code" />
    <button onclick="hostSession()">Create Session</button>
  `;
}

function showJoin() {
  document.getElementById("controls").innerHTML = `
    <input id="joinCode" placeholder="Enter session code" />
    <button onclick="joinSession()">Join Session</button>
  `;
}

async function hostSession() {
  sessionId = document.getElementById("hostCode").value.trim();

  if (!sessionId) {
    alert("Enter a code");
    return;
  }

  createPeer();
  dc = pc.createDataChannel("chat");
  setupDataChannel();

  const offer = await pc.createOffer();
  await pc.setLocalDescription(offer);

  await fetch(`/api/session?id=${sessionId}`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ offer })
  });

  alert("Session created. Share this code.");

  pollInterval = setInterval(async () => {
    const res = await fetch(`/api/session?id=${sessionId}`);
    if (!res.ok) return;

    const data = await res.json();

    if (data.answer && !pc.currentRemoteDescription) {
      await pc.setRemoteDescription(data.answer);
    }

    if (data.candidates) {
      for (const candidate of data.candidates) {
        try {
          await pc.addIceCandidate(candidate);
        } catch {}
      }
    }
  }, 2000);
}

async function joinSession() {
  sessionId = document.getElementById("joinCode").value.trim();

  if (!sessionId) {
    alert("Enter a code");
    return;
  }

  createPeer();

  const res = await fetch(`/api/session?id=${sessionId}`);
  if (!res.ok) {
    alert("Invalid code");
    return;
  }

  const data = await res.json();
  alert("Session found. Connecting...");

  await pc.setRemoteDescription(data.offer);

  const answer = await pc.createAnswer();
  await pc.setLocalDescription(answer);

  await fetch(`/api/session?id=${sessionId}`, {
    method: "PUT",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ answer })
  });

  pollInterval = setInterval(async () => {
    const res = await fetch(`/api/session?id=${sessionId}`);
    if (!res.ok) return;

    const updated = await res.json();

    if (updated.candidates) {
      for (const candidate of updated.candidates) {
        try {
          await pc.addIceCandidate(candidate);
        } catch {}
      }
    }
  }, 2000);
}

function sendMessage() {
  const input = document.getElementById("messageInput");
  if (!dc || dc.readyState !== "open") return;

  dc.send(input.value);
  addMessage("You: " + input.value);
  input.value = "";
}
</script>

</body>
</html>