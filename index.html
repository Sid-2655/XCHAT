<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>XChat</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body {
  margin: 0;
  background: #000;
  color: #00ff88;
  font-family: monospace;
  display: flex;
  justify-content: center;
  align-items: center;
  height: 100vh;
}

.container {
  width: 95%;
  max-width: 450px;
  text-align: center;
}

button {
  background: #001a0f;
  border: 1px solid #00ff88;
  color: #00ff88;
  padding: 12px;
  margin: 8px 0;
  width: 100%;
  font-size: 16px;
  border-radius: 4px;
  cursor: pointer;
}

button:hover {
  background: #00331f;
}

input {
  background: #000;
  border: 1px solid #00ff88;
  color: #00ff88;
  padding: 12px;
  width: 100%;
  margin: 8px 0;
  border-radius: 4px;
}

#chatScreen {
  display: none;
}

#chat {
  border: 1px solid #00ff88;
  height: 220px;
  overflow-y: auto;
  padding: 10px;
  margin-bottom: 10px;
  text-align: left;
  background: #00110a;
}

.status {
  margin: 10px 0;
  font-size: 14px;
}
</style>
</head>

<body>

<div class="container">

  <!-- HOME SCREEN -->
  <div id="homeScreen">
    <h2>üîê XCHAT</h2>
    <button onclick="showHost()">HOST</button>
    <button onclick="showJoin()">JOIN</button>
    <div id="controls"></div>
    <div class="status" id="status"></div>
  </div>

  <!-- CHAT SCREEN -->
  <div id="chatScreen">
    <h2>üü¢ SECURE CHAT</h2>
    <div id="chat"></div>
    <input id="messageInput" placeholder="Type encrypted message..." />
    <button onclick="sendMessage()">SEND</button>
  </div>

</div>

<script>
let pc;
let dc;
let sessionId;
let pollInterval;

function setStatus(text) {
  document.getElementById("status").innerText = text;
}

function switchToChat() {
  document.getElementById("homeScreen").style.display = "none";
  document.getElementById("chatScreen").style.display = "block";
}

function createPeer() {
  pc = new RTCPeerConnection({
    iceServers: [
      { urls: "stun:stun.l.google.com:19302" }
    ]
  });

  pc.onicecandidate = async (event) => {
    if (event.candidate) {
      await fetch(`/api/session?id=${sessionId}`, {
        method: "PATCH",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ candidate: event.candidate })
      });
    }
  };

  pc.onconnectionstatechange = () => {
    if (pc.connectionState === "connected") {
      clearInterval(pollInterval);
      switchToChat();
    }
  };

  pc.ondatachannel = (event) => {
    dc = event.channel;
    setupDataChannel();
  };
}

function setupDataChannel() {
  dc.onmessage = (event) => {
    addMessage("Peer: " + event.data);
  };
}

function addMessage(msg) {
  const chat = document.getElementById("chat");
  chat.innerHTML += "<div>" + msg + "</div>";
  chat.scrollTop = chat.scrollHeight;
}

function showHost() {
  document.getElementById("controls").innerHTML = `
    <input id="hostCode" placeholder="Enter your custom session code" />
    <button onclick="hostSession()">Create Session</button>
  `;
}

function showJoin() {
  document.getElementById("controls").innerHTML = `
    <input id="joinCode" placeholder="Enter session code" />
    <button onclick="joinSession()">Join Session</button>
  `;
}

async function hostSession() {
  sessionId = document.getElementById("hostCode").value.trim();
  if (!sessionId) return alert("Enter a code");

  setStatus("Creating session...");

  createPeer();
  dc = pc.createDataChannel("chat");
  setupDataChannel();

  const offer = await pc.createOffer();
  await pc.setLocalDescription(offer);

  await fetch(`/api/session?id=${sessionId}`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ offer })
  });

  setStatus("Waiting for peer...");

  pollInterval = setInterval(async () => {
    const res = await fetch(`/api/session?id=${sessionId}`);
    if (!res.ok) return;

    const data = await res.json();

    if (data.answer && !pc.currentRemoteDescription) {
      await pc.setRemoteDescription(data.answer);
    }

    if (data.candidates) {
      for (const candidate of data.candidates) {
        try { await pc.addIceCandidate(candidate); } catch {}
      }
    }
  }, 2000);
}

async function joinSession() {
  sessionId = document.getElementById("joinCode").value.trim();
  if (!sessionId) return alert("Enter a code");

  setStatus("Searching session...");

  createPeer();

  const res = await fetch(`/api/session?id=${sessionId}`);
  if (!res.ok) {
    setStatus("Invalid code");
    return;
  }

  const data = await res.json();

  await pc.setRemoteDescription(data.offer);

  const answer = await pc.createAnswer();
  await pc.setLocalDescription(answer);

  await fetch(`/api/session?id=${sessionId}`, {
    method: "PUT",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ answer })
  });

  pollInterval = setInterval(async () => {
    const res = await fetch(`/api/session?id=${sessionId}`);
    if (!res.ok) return;

    const updated = await res.json();

    if (updated.candidates) {
      for (const candidate of updated.candidates) {
        try { await pc.addIceCandidate(candidate); } catch {}
      }
    }
  }, 2000);
}

function sendMessage() {
  const input = document.getElementById("messageInput");
  if (!dc || dc.readyState !== "open") return;

  dc.send(input.value);
  addMessage("You: " + input.value);
  input.value = "";
}
</script>

</body>
</html>