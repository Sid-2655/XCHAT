<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>XChat</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>
    body {
      margin: 0;
      padding: 0;
      background-color: #000;
      color: #00ff88;
      font-family: monospace;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
    }

    .container {
      width: 95%;
      max-width: 450px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    h2 {
      text-align: center;
      margin-bottom: 10px;
      letter-spacing: 2px;
    }
   
   .ticker {
  width: 100%;
  overflow: hidden;
  white-space: nowrap;
  border-top: 1px solid #00ff88;
  border-bottom: 1px solid #00ff88;
  padding: 6px 0;
}

.ticker-text {
  display: inline-block;
  padding-left: 100%;
  animation: scrollText 12s linear infinite;
  font-size: 14px;
  letter-spacing: 1px;
}

@keyframes scrollText {
  0% { transform: translateX(0); }
  100% { transform: translateX(-100%); }
}

    
    button {
      background-color: #001a0f;
      border: 1px solid #00ff88;
      color: #00ff88;
      padding: 12px;
      font-size: 16px;
      cursor: pointer;
      border-radius: 4px;
    }

    button:hover {
      background-color: #00331f;
    }

    input {
      background-color: #000;
      border: 1px solid #00ff88;
      color: #00ff88;
      padding: 12px;
      font-size: 16px;
      border-radius: 4px;
      outline: none;
    }

    #chat {
      border: 1px solid #00ff88;
      height: 220px;
      overflow-y: auto;
      padding: 10px;
      font-size: 14px;
      background-color: #00110a;
    }

    .status {
      text-align: center;
      font-size: 14px;
      opacity: 0.8;
    }
  </style>
</head>

<body>

<div class="container">

  <h2>游댏 XCHAT ENCRYPTED</h2>
   
<div class="ticker">
  <div class="ticker-text">
    XCHAT UNDER DEVELOPMENT - STAY TUNED FOR EXCITING CHANGES
  </div>
</div>


  <button onclick="showHost()">HOST</button>
  <button onclick="showJoin()">JOIN</button>

  <div id="controls"></div>

  <div class="status" id="status">Idle</div>

  <div id="chat"></div>

  <input id="messageInput" placeholder="Type encrypted message..." />
  <button onclick="sendMessage()">SEND</button>

</div>

<script>
let pc;
let dc;
let sessionId;
let pollInterval;

function setStatus(text) {
  document.getElementById("status").innerText = text;
}

function createPeer() {
  pc = new RTCPeerConnection({
    iceServers: [
      { urls: "stun:stun.l.google.com:19302" }
    ]
  });

  pc.onicecandidate = async (event) => {
    if (event.candidate) {
      await fetch(`/api/session?id=${sessionId}`, {
        method: "PATCH",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ candidate: event.candidate })
      });
    }
  };

  pc.onconnectionstatechange = () => {
    if (pc.connectionState === "connected") {
      setStatus("游릭 Secure channel established");
      clearInterval(pollInterval);
    }
  };

  pc.ondatachannel = (event) => {
    dc = event.channel;
    setupDataChannel();
  };
}

function setupDataChannel() {
  dc.onmessage = (event) => {
    addMessage("Peer: " + event.data);
  };
}

function addMessage(msg) {
  const chat = document.getElementById("chat");
  chat.innerHTML += "<div>" + msg + "</div>";
  chat.scrollTop = chat.scrollHeight;
}

function showHost() {
  document.getElementById("controls").innerHTML = `
    <input id="hostCode" placeholder="Enter your custom session code" />
    <button onclick="hostSession()">Create Secure Session</button>
  `;
}

function showJoin() {
  document.getElementById("controls").innerHTML = `
    <input id="joinCode" placeholder="Enter session code" />
    <button onclick="joinSession()">Join Secure Session</button>
  `;
}

async function hostSession() {
  sessionId = document.getElementById("hostCode").value.trim();

  if (!sessionId) {
    alert("Enter a code");
    return;
  }

  setStatus("游릭 Creating session...");

  createPeer();
  dc = pc.createDataChannel("chat");
  setupDataChannel();

  const offer = await pc.createOffer();
  await pc.setLocalDescription(offer);

  await fetch(`/api/session?id=${sessionId}`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ offer })
  });

  setStatus("游릭 Session created. Waiting for peer...");

  pollInterval = setInterval(async () => {
    const res = await fetch(`/api/session?id=${sessionId}`);
    if (!res.ok) return;

    const data = await res.json();

    if (data.answer && !pc.currentRemoteDescription) {
      await pc.setRemoteDescription(data.answer);
    }

    if (data.candidates) {
      for (const candidate of data.candidates) {
        try { await pc.addIceCandidate(candidate); } catch {}
      }
    }
  }, 2000);
}

async function joinSession() {
  sessionId = document.getElementById("joinCode").value.trim();

  if (!sessionId) {
    alert("Enter a code");
    return;
  }

  setStatus("游릭 Searching session...");

  createPeer();

  const res = await fetch(`/api/session?id=${sessionId}`);
  if (!res.ok) {
    setStatus("游댮 Invalid code");
    return;
  }

  const data = await res.json();

  setStatus("游릭 Session found. Connecting...");

  await pc.setRemoteDescription(data.offer);

  const answer = await pc.createAnswer();
  await pc.setLocalDescription(answer);

  await fetch(`/api/session?id=${sessionId}`, {
    method: "PUT",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ answer })
  });

  pollInterval = setInterval(async () => {
    const res = await fetch(`/api/session?id=${sessionId}`);
    if (!res.ok) return;

    const updated = await res.json();

    if (updated.candidates) {
      for (const candidate of updated.candidates) {
        try { await pc.addIceCandidate(candidate); } catch {}
      }
    }
  }, 2000);
}

function sendMessage() {
  const input = document.getElementById("messageInput");

  if (!dc || dc.readyState !== "open") return;

  dc.send(input.value);
  addMessage("You: " + input.value);
  input.value = "";
}
</script>

</body>
</html>